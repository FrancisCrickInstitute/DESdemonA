#' @export
ParamList <- R6::R6Class("ParamList",
                    private = list(
                      params=list(),
                      descriptions=list(alpha="The threshold of statistical significance is {}",
                                        lfcThreshold="The threshold for absolute effect size is {}",
                                        title="The name of the project is '{}'",
                                        script="The project was generated by '{}'",
                                        seed="A random seed of {} is used to ensure reproduciblity"
                                        )
                    ),
                    public = list(
                      initialize = function(title="Analysis",script="?",seed=1) {
                        self$set("title", title)
                        self$set("script", script)
                        self$set("seed", seed)
                      },
                      set = function(id, value, description="", div=TRUE) {
                        private$params[[id]]=value
                        if (description=="") {
                          if (!(id %in% names(private$descriptions))) { # provide tautological definition if 
                            description=paste0("The value of ", id, " is {", id, "}")
                          } else {
                            description=private$descriptions[id]}
                        } 
                        description <- sub("\\{.*\\}", paste0("{", id, "}"), description)
                        private$descriptions[[id]]=description
                        if (div & isTRUE(getOption('knitr.in.progress'))) {
#                          cat(knitr::knit_child(text=knitr::knit_expand(text=c("```{block, type='rparam'}", self$describe(id), "```")), quiet=TRUE))
                          cat("\n\n<div class=\"rparam\">", self$describe(id), "</div>\n\n")
                        }
                        invisible(self)
                      },
                      get = function(id) {
                        private$params[[id]]
                      },
                      describe = function(id) {
                        if (missing(id)) {
                          map(private$descriptions,  function(d) glue::glue_data(.x =private$params, d))
                        } else {
                          glue::glue_data(private$params, private$descriptions[[id]])
                        }
                      }
                    )
                    )
#' Open a device with a trackable name
#'
#' Can be used with 'pdf' 'write.table' etc
#'
#' @param dev contains the function which will be called (which itself will get its 'file' param filled in automatically)
#' @param file string will be used as a starting point for the filename.  If it doesn't contain an extension, will predict from 'dev'
#' @param ignore.chunk if set,  will over-rule the use of knitr override 
#' @return the filename actually used
#' @export
vDevice <- function(dev=list, file=NA, ..., dir="results") {
  g <- remotes:::git("describe --dirty=-M --tags --always")
  if (is.na(file)) return(file.path(dir, g))
  devstr <- as.character(substitute(dev)) # e.g. 'pdf', 'write.txt'
  devstr <- sub(".*\\.", "", devstr) # e.g. 'pdf', 'txt'
  if (!grepl("\\.", file)) {
    file <- paste0(file, ".", devstr)
  }
  if (isTRUE(getOption('knitr.in.progress'))) {
    dName <- file.path(sub("/.*", "", knitr::fig_path()))
  } else {
    dName <- file.path(dir, g)
  }
  if (!dir.exists(dName)) {
    dir.create(dName, recursive=TRUE)
  }
  file <- file.path(dName,sub("([^.]*)(.*)",paste0("\\1_", g, "\\2"), file))
  dev(..., file= file)
  file
}

