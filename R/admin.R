#' R6 class representing the set of parameters used in an analysis
#' 
#' @export
ParamList <- R6::R6Class("ParamList",
                    private = list(
                      params=list(),
                      descriptions=list(alpha="The threshold of statistical significance is {}",
                                        lfcThreshold="The threshold for absolute effect size is {}",
                                        title="The name of the project is '{}'",
                                        top_n_variable="Only use {} genes for unsupervised clustering",
                                        script="The project was generated by '{}'",
                                        showCategory= "Only show top {} enriched categories in plots",
                                        seed="A random seed of {} is used to ensure reproduciblity",
                                        filterFun="{if (is.null(filterFun)) 'Default' else deparse(filterFun)} independent filtering",
                                        baseMeanMin="Discard transcripts with few average counts per sample than {}"
                                        ),
                      defaults=list()
                    ),
                    public = list(
                      #' @description
                      #' Create a new set of parameters.
                      #' @param defaults Named list of default values.  Names are the parameters, and the values will be their default.
                      #' @return An object that will store all future values of analysis parameters.
                      initialize = function(defaults=list()) {
                        private$defaults <- defaults
                      },
                      #' @description
                      #' Set the value of a parameter
                      #' @param id The name of the parameter to be set.
                      #' @param value The value the parameter should taken henceforth; if missing, it will take the default value.
                      #' @param description A string describing what the purpose of the parameter is.
                      #' @param div Logical, whether to mention in the markdown report what the value has been set to.
                      set = function(id, value, description="", div=TRUE) {
                        if (missing(value)) {
                          if (id %in% names(private$defaults)) {
                            value <- private$defaults[[id]]
                          } else {
                            stop("Attempt to set '", id, "' but no value or default provided")
                          }
                        }
                        if (is.null(value)) {
                          private$params[id] <- list(NULL)
                        } else {
                          private$params[[id]]=value
                        }
                        if (description=="") {
                          if (!(id %in% names(private$descriptions))) { # provide tautological definition if 
                            description=paste0("The value of ", id, " is {", id, "}")
                          } else {
                            description=private$descriptions[id]}
                        } 
                        description <- sub("\\{\\}", paste0("{", id, "}"), description)
                        private$descriptions[[id]]=description
                        if (div & isTRUE(getOption('knitr.in.progress'))) {
#                          cat(knitr::knit_child(text=knitr::knit_expand(text=c("```{block, type='rparam'}", self$describe(id), "```")), quiet=TRUE))
                          cat("\n\n<div class=\"rparam\">", self$describe(id), "</div>\n\n")
                        }
                        invisible(self$get(id))
                      },
                      #' @description
                      #' Get the value that the parameter is currently set to.
                      #' @param id Name of the value you want to access.
                      get = function(id) {
                        ret <- private$params[[id]]
                        if (is.call(ret)) eval(ret) else ret
                      },
                      #' @description
                      #' Get a text description of what the setting is, and what value it currently takes.
                      #' @param id Name of the value you want to access.
                      describe = function(id) {
                        if (missing(id)) {
                          map(private$descriptions[names(private$params)],  function(d) glue::glue_data(.x =private$params, d))
                        } else {
                          glue::glue_data(private$params,
                                          private$descriptions[[id]])
                        }
                      }
                    )
                    )
